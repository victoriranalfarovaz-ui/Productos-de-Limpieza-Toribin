<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Productos de limpieza Toribin</title>
  <style>
  :root{
    --bg:#07afb5;
    --card:#2451db;
    --text:#f9f9fb;
    --muted:#fefefe;
    --border:#ffffff;
    --primary:#ff6e6e;
    --danger:#ff6b6b;
    --ok:#f4f8f7;
  }

  *{ box-sizing:border-box; }
  body{
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: radial-gradient(1200px 600px at 20% 0%, #182035 0%, var(--bg) 55%);
    color:var(--text);
    margin:0;
    padding:20px;
  }

  .container{
    max-width: 980px;
    margin: 0 auto;
  }

  header{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:12px;
    margin-bottom: 12px;
  }

  h1{
    margin:0;
    font-size: 28px;
    letter-spacing: .2px;
  }

  h2{
    margin: 18px 0 10px;
    font-size: 18px;
    color: var(--text);
  }

  .muted{ color: var(--muted); }

  .row{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    flex-wrap: wrap;
  }

  .pill{
    padding: 6px 12px;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: rgba(255,255,255,.03);
    color: var(--text);
  }

  .card{
    border: 1px solid var(--border);
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    border-radius: 16px;
    padding: 14px;
    box-shadow: 0 10px 30px rgba(0,0,0,.25);
  }

  .grid{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 14px;
    margin-top: 12px;
  }

  .price{ font-weight: 800; }

  button{
    border: 1px solid var(--border);
    background: rgba(255,255,255,.05);
    color: var(--text);
    padding: 10px 12px;
    border-radius: 12px;
    cursor:pointer;
    transition: transform .05s ease, background .15s ease, border-color .15s ease;
  }
  button:hover{
    background: rgba(255,255,255,.09);
    border-color: rgba(110,231,255,.35);
  }
  button:active{ transform: translateY(1px); }

  .btn-primary{
    border-color: rgba(110,231,255,.35);
    background: rgba(110,231,255,.12);
  }
  .btn-danger{
    border-color: rgba(255,107,107,.35);
    background: rgba(255,107,107,.12);
  }

  input, textarea, select{
    width: 100%;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: rgba(0,0,0,.25);
    color: var(--text);
    outline: none;
  }
  input::placeholder, textarea::placeholder{ color: rgba(169,176,195,.7); }

  #carrito{ margin-top: 18px; }

  .item{
    display:grid;
    grid-template-columns: 1fr auto auto auto;
    gap: 10px;
    align-items:center;
    padding: 12px 0;
    border-bottom: 1px solid rgba(255,255,255,.06);
  }
  .item:last-child{ border-bottom: none; }

  .qtyBtns{ display:flex; gap:8px; align-items:center; }

  .totalBox{
    margin-top: 12px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap: 10px;
    flex-wrap: wrap;
  }

  /* Mobile */
  @media (max-width: 520px){
    body{ padding: 14px; }
    h1{ font-size: 22px; }
    .item{ grid-template-columns: 1fr auto; grid-auto-rows: auto; }
    .item > div:nth-child(3),
    .item > div:nth-child(4){ justify-self: end; }
  }

  .product-img{
  width: 100%;
  height: 160px;
  object-fit: contain;
  background: #ffffff;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.08);
  padding: 10px;
  margin-bottom: 10px;
}

.product-img{
  cursor: pointer;
  transition: transform .2s ease, box-shadow .2s ease;
}

.product-img:hover{
  transform: scale(1.03);
  box-shadow: 0 10px 30px rgba(0,255,240,.25);
}

.btn-soft{
  opacity: .75;
}
.btn-soft:hover{
  opacity: 1;
}

/* Advertencia al pasar el mouse */
.btn-warning:hover{
  box-shadow: 0 0 0 2px rgba(255, 80, 80, 0.9);
}    
    
.icon-badge{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width: 34px;
  height: 34px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.05);
}

.card{
  transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
}

.card:hover{
  transform: translateY(-4px);
  box-shadow: 0 20px 40px rgba(0,0,0,.4);
  border-color: rgba(110,231,255,.4);
}

.tag{
  font-size: 12px;
  padding: 4px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
  color: var(--muted);
}

.tag {
  transition: all 0.25s ease;
}

.tag:hover {
  transform: scale(1.08);
  box-shadow: 0 6px 20px rgba(0, 255, 240, 0.35);
}


.tag.limpieza{
  background: rgba(0, 210, 200, 0.25);
  color: #eaffff;
  border: 1px solid rgba(0, 210, 200, 0.5);
}
.tag.ropa{
  background: rgba(0, 210, 200, 0.25);
  color: #eaffff;
  border: 1px solid rgba(0, 210, 200, 0.5);
}
.tag.suavizante{
  background: rgba(0, 210, 200, 0.25);
  color: #eaffff;
  border: 1px solid rgba(0, 210, 200, 0.5);
}

.tag.limpieza:hover,
.tag.ropa:hover,
.tag.suavizante:hover {
  background: rgba(0, 255, 240, 0.45);
}


</style>

</head>
<body>
  <div class="container">


  <header>
    <div>
      <h1>Productos de limpieza Toribin </h1>
      <div class="muted">Tenemos los mejores productos para limpieza del hogar o auto</div>
    </div>
    <div class="pill">Carrito: <span id="contador">0</span></div>
  </header>

  <div class="row" style="justify-content:flex-start; gap:8px; margin-top:10px;">
  <button id="btnVistaCliente" class="btn-primary">Vista cliente</button>
  <button id="btnVistaAdmin">Vista admin</button>
  </div>


  <section id="vistaCliente">
  <div class="row" style="margin-top: 16px;">
  <h2 style="margin:0;">Productos</h2>

  <input
    id="buscador"
    type="search"
    placeholder="Buscar (ej. detergente, ropa, clarasol...)"
    style="max-width: 360px;"
  />
</div>

<div class="grid" id="lista-productos"></div>


  <section id="carrito">
    <h2>Carrito</h2>
    <div id="carrito-items" class="card"></div>

    <div class="totalBox">
      <strong>Total: $<span id="total">0.00</span></strong>
      <button id="vaciar" class="btn-primary btn-soft btn-warning">Vaciar carrito</button>
    </div>

    <div style="margin-top: 12px;">
      <button id="checkout" class="btn-primary">Finalizar compra</button>
    </div>

    <!-- FORM CHECKOUT -->
    <div id="checkout-form" class="card" style="margin-top: 12px; display: none;">
      <h3 style="margin-top: 0;">Datos de entrega</h3>

      <label>Nombre</label><br>
      <input id="nombre" type="text"
        style="width: 100%; padding: 10px; margin: 6px 0 12px;"
        placeholder="Tu nombre" />

      <label>Tel√©fono</label><br>
      <input id="telefono" type="tel"
        style="width: 100%; padding: 10px; margin: 6px 0 12px;"
        placeholder="Ej. 55 1234 5678" />

      <label>Direcci√≥n</label><br>
      <textarea id="direccion" rows="3"
        style="width: 100%; padding: 10px; margin: 6px 0 12px;"
        placeholder="Calle, n√∫mero, colonia, referencias..."></textarea>

      <div class="row">
       <button id="confirmar" type="button" class="btn-primary">Confirmar pedido</button>
       <button id="cancelar" type="button">Cancelar</button>
      </div>
    </div>
  </section>
</section> <!-- fin vistaCliente -->


    <!-- ADMIN DEMO -->
    <section id="vistaAdmin" style="display:none;">
    <div id="admin" class="card" style="margin-top: 18px;">
    <h3 style="margin-top: 0;">Pedidos</h3>
    <div class="row" style="margin-bottom:10px;">
    <strong>Panel de Pedidos</strong>
    <button id="btnHistorial">Ver historial</button>
    <button id="btnExportar" class="btn-primary">Exportar a Excel</button>
    <button id="btnSalirAdmin">Salir</button>
    </div>
    <div id="lista-pedidos" class="muted">A√∫n no hay pedidos.</div>
    </div>
</section>


  <script>

   const WHATSAPP_NEGOCIO = "525660578484";

// guarda pedido central
async function guardarPedidoEnSheets(pedido) {
  try {
    const res = await fetch("/api/pedido", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(pedido)
    });

    const data = await res.json();
    if (!data.ok) throw new Error(data.error || "No se pudo guardar en Sheets");
  } catch (err) {
    console.error("Error:", err);
    alert("Error enviando pedido al sistema central");
    throw err;
  }
}

// carga pedidos central (admin)
async function cargarPedidosCentral() {
  const res = await fetch("/api/pedidos");
  const data = await res.json();

  if (!data.ok) throw new Error(data.error || "No se pudieron cargar pedidos");

  pedidos = (data.pedidos || []).map(row => ({
    id: row.pedido_id || "",
    estado: row.estado || "pendiente",
    creadoEn: row.fecha || "",
    total: Number(row.total || 0),
    comprador: {
      nombre: row.cliente || "",
      telefono: row.telefono || "",
      direccion: row.direccion || ""
    },
    items: String(row.items || "")
      .split(" | ")
      .filter(Boolean)
      .map(txt => ({ nombre: txt, cantidad: 1, precioUnitario: 0 }))
  }));

  renderPedidos();
}
    
    // Productos (puedes cambiarlos)
    const productos = [
  {
    id: 1,
    nombre: "Clarasol Multiusos",
    precio: 8.00,
    desc: "Clarasol multiusos 1lt",
    img: "img/clarasol.jpg",
    icon: "üß¥",
    categoria: "limpieza"
  },
  {
    id: 2,
    nombre: "Detergente Ropa Color",
    precio: 18.00,
    desc: "Detergente para ropa de color 1lt",
    img: "img/detergente-color.jpg",
    icon: "üëï",
    categoria: "ropa"
  },
  {
    id: 3,
    nombre: "Detergente Ropa Blanca",
    precio: 18.00,
    desc: "Detergente para ropa blanca 1lt",
    img: "img/detergente-blanco.jpg",
    icon: "ü´ß",
    categoria: "ropa"
  },
  {
    id: 4,
    nombre: "Enjuague Ropa Color",
    precio: 18.00,
    desc: "Enjuague para ropa de color",
    img: "img/enjuague.jpg",
    icon: "üå∏",
    categoria: "suavizante"
  }
];


    // Carrito
    let carrito = [];

    // Pedidos (demo)
    let pedidos = [];
    let folio = 1;

    const STORAGE_KEY = "mi_tienda_v1";
    const ADMIN_PIN = "1234"; // c√°mbialo por el que quieras



function guardarEstado() {
  const data = { carrito, pedidos, folio };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

    async function guardarPedidoEnSheets(pedido) {
  try {
    const res = await fetch("/api/pedido", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(pedido)
    });

    const data = await res.json();
    console.log("Respuesta API:", data);

    if (!data.ok) {
      throw new Error(data.error || "No se pudo guardar en Sheets");
    }

  } catch (err) {
    console.error("Error:", err);
    alert("Error enviando pedido al sistema central");
    throw err;
  }
}

    

function cargarEstado() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return;

  try {
    const data = JSON.parse(raw);
    carrito = Array.isArray(data.carrito) ? data.carrito : [];
    pedidos = Array.isArray(data.pedidos) ? data.pedidos : [];
    folio = Number.isFinite(data.folio) ? data.folio : 1;
  } catch (e) {
    // si algo se corrompe, lo ignoramos para que la app no se rompa
    carrito = [];
    pedidos = [];
    folio = 1;
  }
}

function resetearDatos() {
  localStorage.removeItem(STORAGE_KEY);
  carrito = [];
  pedidos = [];
  folio = 1;
  renderCarrito();
  renderPedidos();
}

function formatearFecha(iso) {
  if (!iso) return "";
    const d = new Date(iso);
  return d.toLocaleString("es-MX", {
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit"
  });
}



    // Elementos
    const listaProductosEl = document.getElementById("lista-productos");
    const carritoItemsEl = document.getElementById("carrito-items");
    const totalEl = document.getElementById("total");
    const contadorEl = document.getElementById("contador");
    const btnVaciar = document.getElementById("vaciar");
    const btnCheckout = document.getElementById("checkout");

    const checkoutFormEl = document.getElementById("checkout-form");
    const nombreEl = document.getElementById("nombre");
    const telefonoEl = document.getElementById("telefono");
    const direccionEl = document.getElementById("direccion");
    const btnConfirmar = document.getElementById("confirmar");
    const btnCancelar = document.getElementById("cancelar");
    const listaPedidosEl = document.getElementById("lista-pedidos");

    const vistaClienteEl = document.getElementById("vistaCliente");
    const vistaAdminEl = document.getElementById("vistaAdmin");
    const btnVistaCliente = document.getElementById("btnVistaCliente");
    const btnVistaAdmin = document.getElementById("btnVistaAdmin");
    const btnSalirAdmin = document.getElementById("btnSalirAdmin");
    const buscadorEl = document.getElementById("buscador");
    const btnHistorial = document.getElementById("btnHistorial");
    const btnExportar = document.getElementById("btnExportar");

    function exportarPedidosCSV() {
  if (!pedidos || pedidos.length === 0) {
    alert("No hay pedidos para exportar.");
    return;
  }

  // Aplana pedidos + items (1 fila por item)
  const filas = [];
  pedidos.forEach(p => {
    (p.items || []).forEach(it => {
      filas.push({
        pedido_id: p.id,
        estado: p.estado,
        creado: p.creadoEn || "",
        archivado: p.archivadoEn || "",
        cliente: p.comprador?.nombre || "",
        telefono: p.comprador?.telefono || "",
        direccion: p.comprador?.direccion || "",
        item: it.nombre,
        cantidad: it.cantidad,
        precio_unitario: it.precioUnitario,
        subtotal_item: (it.cantidad * it.precioUnitario),
        total_pedido: p.total
      });
    });

    // Si un pedido no tiene items por alguna raz√≥n, igual lo metemos:
    if (!p.items || p.items.length === 0) {
      filas.push({
        pedido_id: p.id,
        estado: p.estado,
        creado: p.creadoEn || "",
        archivado: p.archivadoEn || "",
        cliente: p.comprador?.nombre || "",
        telefono: p.comprador?.telefono || "",
        direccion: p.comprador?.direccion || "",
        item: "",
        cantidad: "",
        precio_unitario: "",
        subtotal_item: "",
        total_pedido: p.total
      });
    }
  });

  const encabezados = Object.keys(filas[0]);
  const escapeCSV = (v) => {
    const s = String(v ?? "");
    // Escapa comillas y fuerza comillas si hay coma/salto de l√≠nea
    const needsQuotes = /[",\n]/.test(s);
    const escaped = s.replace(/"/g, '""');
    return needsQuotes ? `"${escaped}"` : escaped;
  };

  const csv = [
    encabezados.join(","),
    ...filas.map(row => encabezados.map(k => escapeCSV(row[k])).join(","))
  ].join("\n");

  // BOM para que Excel respete acentos
  const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `pedidos_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();

  URL.revokeObjectURL(url);
}

btnExportar?.addEventListener("click", exportarPedidosCSV);

  let viendoHistorial = false;

btnHistorial.addEventListener("click", () => {
  viendoHistorial = !viendoHistorial;
  btnHistorial.textContent = viendoHistorial ? "Ver activos" : "Historial";
  renderPedidos();
});


    let buscadorTimer = null;
buscadorEl.addEventListener("input", () => {
  if (buscadorTimer) clearTimeout(buscadorTimer);
  buscadorTimer = setTimeout(() => renderProductos(), 150);
});
listaProductosEl.addEventListener("click", (e) => {
  const btn = e.target.closest("button[data-id]");
  if (!btn) return;

  const id = parseInt(btn.dataset.id, 10);
  if (Number.isNaN(id)) return;
  agregarAlCarrito(id);
});
    btnSalirAdmin.addEventListener("click", () => {
  mostrarCliente();
});
async function cargarPedidosCentral() {
  const res = await fetch("/api/pedidos");
  const data = await res.json();

  if (!data.ok) throw new Error(data.error || "No se pudieron cargar pedidos");

  pedidos = (data.pedidos || []).map(row => ({
    id: row.pedido_id || "",
    estado: row.estado || "pendiente",
    creadoEn: row.fecha || "",
    total: Number(row.total || 0),
    comprador: {
      nombre: row.cliente || "",
      telefono: row.telefono || "",
      direccion: row.direccion || ""
    },
    items: String(row.items || "")
      .split(" | ")
      .filter(Boolean)
      .map(txt => ({ nombre: txt, cantidad: 1, precioUnitario: 0 }))
  }));

  renderPedidos();
}
    
setInterval(() => {
  if (vistaAdminEl.style.display === "block") {
    cargarPedidosCentral().catch(() => {});
  }
}, 15000); // cada 15s


  function mostrarCliente() {
    vistaClienteEl.style.display = "block";
    vistaAdminEl.style.display = "none";
}

  function mostrarAdmin() {
    vistaClienteEl.style.display = "none";
    vistaAdminEl.style.display = "block";
    checkoutFormEl.style.display = "none"; // por si estaba abierto
}

btnVistaCliente.addEventListener("click", mostrarCliente);
btnVistaAdmin.addEventListener("click", async () => {
  if (vistaAdminEl.style.display === "block") return;

  const intento = prompt("Ingresa el PIN de admin:");
  if (intento !== ADMIN_PIN) {
    alert("PIN incorrecto.");
    return;
  }

  mostrarAdmin();

  try {
    await cargarPedidosCentral();
  } catch (e) {
    console.error(e);
    alert("No pude cargar pedidos del sistema central.");
  }
});

  function renderProductos() {
  const q = (buscadorEl.value || "").trim().toLowerCase();

  const filtrados = productos.filter(p => {
    const texto = `${p.nombre} ${p.desc} ${p.categoria ?? ""}`.toLowerCase();
    return texto.includes(q);
  });

  listaProductosEl.innerHTML = "";

  if (filtrados.length === 0) {
    listaProductosEl.innerHTML = `
      <div class="card">
        <strong>No se encontraron productos</strong>
        <div class="muted" style="margin-top:6px;">Prueba con otra palabra.</div>
      </div>
    `;
    return;
  }

  filtrados.forEach(p => {
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <img class="product-img add-by-image" data-id="${p.id}" src="${p.img}" alt="${p.nombre}" />

      <div class="row">
        <div style="display:flex; align-items:center; gap:10px;">
          <span class="icon-badge">${p.icon ?? "üõçÔ∏è"}</span>
          <h3 style="margin: 0;">${p.nombre}</h3>
        </div>
        <div class="tag ${p.categoria ?? ""}">${p.categoria ?? "producto"}</div>
      </div>

      <div class="row" style="margin-top:6px;">
        <span class="price">$${p.precio.toFixed(2)}</span>
      </div>

      <p class="muted" style="margin: 8px 0 12px;">${p.desc}</p>
      <button data-id="${p.id}" class="btn-primary">Agregar al carrito</button>
    `;

    listaProductosEl.appendChild(card);
  });
}

   function agregarAlCarrito(productoId) {
  const p = productos.find(x => x.id === productoId);
  if (!p) {
    alert("No se encontr√≥ el producto (id inv√°lido).");
    console.log("Producto no encontrado:", productoId);
    return;
  }

  const existente = carrito.find(i => i.productoId === productoId);
  if (existente) {
    existente.cantidad += 1;
  } else {
    carrito.push({
      productoId: p.id,
      nombre: p.nombre,
      precioUnitario: p.precio,
      cantidad: 1
    });
  }

  renderCarrito();
}


    function cambiarCantidad(productoId, delta) {
      const item = carrito.find(i => i.productoId === productoId);
      if (!item) return;
      item.cantidad += delta;
      if (item.cantidad <= 0) carrito = carrito.filter(i => i.productoId !== productoId);
      renderCarrito();
    }

    function vaciarCarrito() {
      carrito = [];
      renderCarrito();
    }

    function renderCarrito() {
      if (carrito.length === 0) {
        carritoItemsEl.innerHTML = `<p class="muted">Tu carrito est√° vac√≠o.</p>`;
      } else {
        carritoItemsEl.innerHTML = "";
        carrito.forEach(item => {
          const subtotal = item.precioUnitario * item.cantidad;

          const row = document.createElement("div");
          row.className = "item";
          row.innerHTML = `
            <div>
              <strong>${item.nombre}</strong><br>
              <span class="muted">$${item.precioUnitario.toFixed(2)} c/u</span>
            </div>

            <div class="qtyBtns">
              <button aria-label="menos">-</button>
              <span class="pill">${item.cantidad}</span>
              <button aria-label="m√°s">+</button>
            </div>

            <div><strong>$${subtotal.toFixed(2)}</strong></div>
            <div><button aria-label="quitar">Quitar</button></div>
          `;

          const [btnMenos, btnMas] = row.querySelectorAll(".qtyBtns button");
          const btnQuitar = row.querySelector('button[aria-label="quitar"]');

          btnMenos.addEventListener("click", () => cambiarCantidad(item.productoId, -1));
          btnMas.addEventListener("click", () => cambiarCantidad(item.productoId, +1));
          btnQuitar.addEventListener("click", () => {
            carrito = carrito.filter(i => i.productoId !== item.productoId);
            renderCarrito();
          });

          carritoItemsEl.appendChild(row);
        });
      }

      const total = carrito.reduce((acc, item) => acc + item.precioUnitario * item.cantidad, 0);
      totalEl.textContent = total.toFixed(2);

      const contador = carrito.reduce((acc, item) => acc + item.cantidad, 0);
      contadorEl.textContent = contador;

      guardarEstado();

      
    }

    // Checkout
    btnCheckout.addEventListener("click", () => {
      if (carrito.length === 0) {
        alert("Tu carrito est√° vac√≠o.");
        return;
      }
      checkoutFormEl.style.display = "block";
    });

    btnCancelar.addEventListener("click", () => {
      checkoutFormEl.style.display = "none";
    });

    let enviandoPedido = false;

btnConfirmar.addEventListener("click", async (e) => {
  e.preventDefault();
  e.stopPropagation();

  if (enviandoPedido) return;

  const nombre = nombreEl.value.trim();
  const telefono = telefonoEl.value.trim();
  const direccion = direccionEl.value.trim();

  if (!nombre || !telefono || !direccion) {
    alert("Por favor llena nombre, tel√©fono y direcci√≥n.");
    return;
  }
  if (carrito.length === 0) {
    alert("Tu carrito est√° vac√≠o.");
    return;
  }

  enviandoPedido = true;
  btnConfirmar.disabled = true;
  const textoOriginal = btnConfirmar.textContent;
  btnConfirmar.textContent = "Enviando...";

  try {
    const total = carrito.reduce((acc, item) => acc + item.precioUnitario * item.cantidad, 0);

    const pedido = {
      id: `PED-${String(folio).padStart(4, "0")}`,
      items: carrito.map(i => ({ ...i })),
      total,
      comprador: { nombre, telefono, direccion },
      estado: "pendiente",
      creadoEn: new Date().toISOString()
    };

    // ‚úÖ sube folio ANTES de enviar para que si hay doble evento no reuse el mismo
    folio += 1;

    // guarda local
    pedidos.unshift(pedido);
    guardarEstado();

    await cargarPedidosCentral();

// WhatsApp
const texto = encodeURIComponent(armarMensajeWhatsApp(pedido));
window.open(`https://wa.me/${WHATSAPP_NEGOCIO}?text=${texto}`, "_blank");


    // limpiar
    vaciarCarrito();
    nombreEl.value = "";
    telefonoEl.value = "";
    direccionEl.value = "";
    checkoutFormEl.style.display = "none";

    renderPedidos();
    alert(`Pedido creado: ${pedido.id}`);
  } catch (err) {
    console.error(err);
    alert("No se pudo enviar el pedido. Intenta de nuevo.");
  } finally {
    btnConfirmar.disabled = false;
    btnConfirmar.textContent = textoOriginal;
    enviandoPedido = false;
  }
}, true); // üëà captura: evita doble disparo raro en mobile


    function renderPedidos() {
  listaPedidosEl.className = "";
  listaPedidosEl.innerHTML = "";

  const lista = viendoHistorial
    ? pedidos.filter(p => p.estado === "archivado")
    : pedidos.filter(p => p.estado !== "archivado");

  if (lista.length === 0) {
    listaPedidosEl.textContent = viendoHistorial
      ? "No hay pedidos archivados."
      : "A√∫n no hay pedidos.";
    listaPedidosEl.className = "muted";
    guardarEstado();
    return;
  }

  lista.forEach(p => {
    const div = document.createElement("div");
    div.style.borderBottom = "1px solid rgba(255,255,255,.08)";
    div.style.padding = "12px 0";

    const items = p.items.map(i => `${i.nombre} x${i.cantidad}`).join(", ");

    div.innerHTML = `
      <div class="row">
        <strong>${p.id}</strong>
        <span class="pill">Estado: ${p.estado}</span>
      </div>

      <div style="margin-top:6px;">
        <div><strong>Cliente:</strong> ${p.comprador.nombre} (${p.comprador.telefono})</div>
        <div><strong>Direcci√≥n:</strong> ${p.comprador.direccion}</div>
        <div><strong>Items:</strong> ${items}</div>
        <div><strong>Total:</strong> $${p.total.toFixed(2)}</div>

        <div class="muted" style="margin-top:6px;">
          <div><strong>Creado:</strong> ${formatearFecha(p.creadoEn)}</div>
          ${
            p.archivadoEn
              ? `<div><strong>Archivado:</strong> ${formatearFecha(p.archivadoEn)} (${p.archivadoPor || "admin"})</div>`
              : ""
          }
        </div>
      </div>

      ${
        viendoHistorial
          ? `
            <div class="row" style="margin-top:10px; justify-content:flex-end;">
              <button class="btn-primary" data-restore="${p.id}">Restaurar</button>
            </div>
          `
          : `
            <div style="margin-top:10px;" class="row">
              <label class="muted">Cambiar estado:</label>
              <select data-id="${p.id}">
                <option value="pendiente" ${p.estado === "pendiente" ? "selected" : ""}>pendiente</option>
                <option value="en_camino" ${p.estado === "en_camino" ? "selected" : ""}>en_camino</option>
                <option value="entregado" ${p.estado === "entregado" ? "selected" : ""}>entregado</option>
              </select>
            </div>

            <div class="row" style="margin-top:10px; justify-content:flex-end;">
              <button class="btn-danger" data-archive="${p.id}">Archivar</button>
            </div>
          `
      }
    `;

    // Cambiar estado (solo activos)
    const select = div.querySelector(`select[data-id="${p.id}"]`);
    if (select) {
      select.addEventListener("change", (e) => {
        p.estado = e.target.value;
        guardarEstado();
        renderPedidos();
      });
    }

    // Archivar (solo activos)
    const btnArch = div.querySelector(`[data-archive="${p.id}"]`);
    if (btnArch) {
      btnArch.addEventListener("click", () => {
        if (!confirm("¬øArchivar este pedido?")) return;
        p.estado = "archivado";
        p.archivadoEn = new Date().toISOString();
        p.archivadoPor = "admin";
        guardarEstado();
        renderPedidos();
      });
    }

    // Restaurar (solo historial)
    const btnRes = div.querySelector(`[data-restore="${p.id}"]`);
    if (btnRes) {
      btnRes.addEventListener("click", () => {
        if (!confirm("¬øRestaurar este pedido a activos?")) return;
        p.estado = "pendiente";
        p.archivadoEn = null;
        p.archivadoPor = null;
        guardarEstado();
        renderPedidos();
      });
    }

    listaPedidosEl.appendChild(div);
  });

  guardarEstado();
}

function armarMensajeWhatsApp(pedido){
  const itemsTxt = (pedido.items || [])
    .map(i => `- ${i.nombre} x${i.cantidad} ($${i.precioUnitario.toFixed(2)} c/u)`)
    .join("\n");

  const msg =
`*NUEVO PEDIDO* ${pedido.id}
${formatearFecha(pedido.creadoEn)}

*Cliente:* ${pedido.comprador.nombre}
*Tel:* ${pedido.comprador.telefono}
*Direcci√≥n:* ${pedido.comprador.direccion}

*Items:*
${itemsTxt}

*Total:* $${pedido.total.toFixed(2)}
*Estado:* ${pedido.estado}`;

  return msg;
}

    // Iniciar
  cargarEstado();
  renderProductos();
  renderCarrito();
  renderPedidos();
  mostrarCliente();

    document.addEventListener("click", function(e) {
  const img = e.target.closest(".add-by-image");
  if (!img) return;

  const id = img.getAttribute("data-id");
  const btn = document.querySelector(`button[data-id="${id}"]`);
  if (btn) btn.click();
});
    
btnVaciar.addEventListener("click", () => {
  const ok = confirm("¬øSeguro que quieres vaciar el carrito? Esta acci√≥n no se puede deshacer.");
  if (!ok) return;

  carrito = [];
  renderCarrito(); // tambi√©n guarda estado
});

  </script>

</body>
</html>
