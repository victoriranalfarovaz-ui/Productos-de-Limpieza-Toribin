<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Productos de limpieza Toribin</title>
  <style>
  :root{
    --bg:#07afb5;
    --card:#2451db;
    --text:#f9f9fb;
    --muted:#fefefe;
    --border:#ffffff;
    --primary:#ff6e6e;
    --danger:#ff6b6b;
    --ok:#f4f8f7;
  }

  *{ box-sizing:border-box; }
  body{
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: radial-gradient(1200px 600px at 20% 0%, #182035 0%, var(--bg) 55%);
    color:var(--text);
    margin:0;
    padding:20px;
  }

  .container{
    max-width: 980px;
    margin: 0 auto;
  }

  header{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:12px;
    margin-bottom: 12px;
  }

  h1{
    margin:0;
    font-size: 28px;
    letter-spacing: .2px;
  }

  h2{
    margin: 18px 0 10px;
    font-size: 18px;
    color: var(--text);
  }

  .muted{ color: var(--muted); }

  .row{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    flex-wrap: wrap;
  }

  .pill{
    padding: 6px 12px;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: rgba(255,255,255,.03);
    color: var(--text);
  }

  .card{
    border: 1px solid var(--border);
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    border-radius: 16px;
    padding: 14px;
    box-shadow: 0 10px 30px rgba(0,0,0,.25);
  }

  .grid{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 14px;
    margin-top: 12px;
  }

  .price{ font-weight: 800; }

  button{
    border: 1px solid var(--border);
    background: rgba(255,255,255,.05);
    color: var(--text);
    padding: 10px 12px;
    border-radius: 12px;
    cursor:pointer;
    transition: transform .05s ease, background .15s ease, border-color .15s ease;
  }
  button:hover{
    background: rgba(255,255,255,.09);
    border-color: rgba(110,231,255,.35);
  }
  button:active{ transform: translateY(1px); }

  .btn-primary{
    border-color: rgba(110,231,255,.35);
    background: rgba(110,231,255,.12);
  }
  .btn-danger{
    border-color: rgba(255,107,107,.35);
    background: rgba(255,107,107,.12);
  }

  input, textarea, select{
    width: 100%;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: rgba(0,0,0,.25);
    color: var(--text);
    outline: none;
  }
  input::placeholder, textarea::placeholder{ color: rgba(169,176,195,.7); }

  #carrito{ margin-top: 18px; }

  .item{
    display:grid;
    grid-template-columns: 1fr auto auto auto;
    gap: 10px;
    align-items:center;
    padding: 12px 0;
    border-bottom: 1px solid rgba(255,255,255,.06);
  }
  .item:last-child{ border-bottom: none; }

  .qtyBtns{ display:flex; gap:8px; align-items:center; }

  .totalBox{
    margin-top: 12px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap: 10px;
    flex-wrap: wrap;
  }

  /* Mobile */
  @media (max-width: 520px){
    body{ padding: 14px; }
    h1{ font-size: 22px; }
    .item{ grid-template-columns: 1fr auto; grid-auto-rows: auto; }
    .item > div:nth-child(3),
    .item > div:nth-child(4){ justify-self: end; }
  }

  .product-img{
  width: 100%;
  height: 160px;
  object-fit: contain;
  background: #ffffff;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.08);
  padding: 10px;
  margin-bottom: 10px;
}

.product-img{
  cursor: pointer;
  transition: transform .2s ease, box-shadow .2s ease;
}

.product-img:hover{
  transform: scale(1.03);
  box-shadow: 0 10px 30px rgba(0,255,240,.25);
}

.btn-soft{
  opacity: .75;
}
.btn-soft:hover{
  opacity: 1;
}

/* Advertencia al pasar el mouse */
.btn-warning:hover{
  box-shadow: 0 0 0 2px rgba(255, 80, 80, 0.9);
}    
    
.icon-badge{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width: 34px;
  height: 34px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.05);
}

.card{
  transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
}

.card:hover{
  transform: translateY(-4px);
  box-shadow: 0 20px 40px rgba(0,0,0,.4);
  border-color: rgba(110,231,255,.4);
}

.tag{
  font-size: 12px;
  padding: 4px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
  color: var(--muted);
}

.tag {
  transition: all 0.25s ease;
}

.tag:hover {
  transform: scale(1.08);
  box-shadow: 0 6px 20px rgba(0, 255, 240, 0.35);
}


.tag.limpieza{
  background: rgba(0, 210, 200, 0.25);
  color: #eaffff;
  border: 1px solid rgba(0, 210, 200, 0.5);
}
.tag.ropa{
  background: rgba(0, 210, 200, 0.25);
  color: #eaffff;
  border: 1px solid rgba(0, 210, 200, 0.5);
}
.tag.suavizante{
  background: rgba(0, 210, 200, 0.25);
  color: #eaffff;
  border: 1px solid rgba(0, 210, 200, 0.5);
}

.tag.limpieza:hover,
.tag.ropa:hover,
.tag.suavizante:hover {
  background: rgba(0, 255, 240, 0.45);
}


</style>

</head>
<body>
  <div class="container">


  <header>
    <div>
      <h1>Productos de limpieza Toribin </h1>
      <div class="muted">Tenemos los mejores productos para limpieza del hogar o auto</div>
    </div>
    <div class="pill">Carrito: <span id="contador">0</span></div>
  </header>

  <div class="row" style="justify-content:flex-start; gap:8px; margin-top:10px;">
  </div>


  <section id="vistaCliente">
  <div class="row" style="margin-top: 16px;">
  <h2 style="margin:0;">Productos</h2>

  <input
    id="buscador"
    type="search"
    placeholder="Buscar (ej. detergente, ropa, clarasol...)"
    style="max-width: 360px;"
  />
</div>

<div class="grid" id="lista-productos"></div>


  <section id="carrito">
    <h2>Carrito</h2>
    <div id="carrito-items" class="card"></div>

    <div class="totalBox">
      <strong>Total: $<span id="total">0.00</span></strong>
      <button id="vaciar" class="btn-primary btn-soft btn-warning">Vaciar carrito</button>
    </div>

    <div style="margin-top: 12px;">
      <button id="checkout" class="btn-primary">Finalizar compra</button>
    </div>

    <!-- FORM CHECKOUT -->
    <div id="checkout-form" class="card" style="margin-top: 12px; display: none;">
      <h3 style="margin-top: 0;">Datos de entrega</h3>

      <label>Nombre</label><br>
      <input id="nombre" type="text"
        style="width: 100%; padding: 10px; margin: 6px 0 12px;"
        placeholder="Tu nombre" />

      <label>Tel√©fono</label><br>
      <input id="telefono" type="tel"
        style="width: 100%; padding: 10px; margin: 6px 0 12px;"
        placeholder="Ej. 55 1234 5678" />

      <label>Direcci√≥n</label><br>
      <textarea id="direccion" rows="3"
        style="width: 100%; padding: 10px; margin: 6px 0 12px;"
        placeholder="Calle, n√∫mero, colonia, referencias..."></textarea>

      <div class="row">
       <button id="confirmar" type="button" class="btn-primary">Confirmar pedido</button>
       <button id="cancelar" type="button">Cancelar</button>
      </div>
    </div>
  </section>
</section> <!-- fin vistaCliente -->
<script>
const SHEETS_URL = "https://script.google.com/macros/s/AKfycbwuMxVw9sAKYAanyWmuzVk7GhmHKtvUgW4UJlUhrSge-L1OwNu-yYNX9Z50VjEE5jI9/exec";

const WHATSAPP_NEGOCIO = "525642341448";

let carrito = [];
let pedidos = [];
let folio = 1;
let viendoHistorial = false;

async function guardarPedidoEnSheets(pedido) {
  const payload = {
    accion: "guardarPedido",
    id: pedido.id,
    cliente: pedido.comprador?.nombre || "",
    telefono: pedido.comprador?.telefono || "",
    direccion: pedido.comprador?.direccion || "",
    items: Array.isArray(pedido.items) ? pedido.items : [],
    total: Number(pedido.total || 0),
    estado: pedido.estado || "pendiente",
    creadoEn: pedido.creadoEn || new Date().toISOString(),
  };

  console.log("PAYLOAD A SHEETS:", payload);

  const res = await fetch(SHEETS_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify(payload),
    redirect: "follow",
  });

  const txt = await res.text();
  console.log("RESPUESTA SHEETS (raw):", txt);

  let data;
  try { data = JSON.parse(txt); }
  catch (e) { throw new Error("Sheets no devolvi√≥ JSON"); }

  if (!data.ok) throw new Error(data.error || "No se pudo guardar en Sheets");
}

async function cargarPedidosCentral() {
  const res = await fetch(`${SHEETS_URL}?accion=obtenerPedidos`, { redirect: "follow" });

  const txt = await res.text();
  console.log("GET PEDIDOS (raw):", txt);

  let data;
  try { data = JSON.parse(txt); }
  catch (e) { throw new Error("La respuesta de obtenerPedidos NO es JSON"); }

  if (!data.ok) throw new Error(data.error || "No se pudieron cargar pedidos");

  pedidos = (data.pedidos || []).map((row) => ({
    id: row.pedido_id || "",
    estado: row.estado || "pendiente",
    creadoEn: row.fecha || "",
    total: Number(row.total || 0),
    comprador: {
      nombre: row.cliente || "",
      telefono: row.telefono || "",
      direccion: row.direccion || "",
    },
    // si en sheets guardas items como "A x2 | B x1", aqu√≠ lo convertimos a array
    items: String(row.items || "")
      .split(" | ")
      .filter(Boolean)
      .map((txt) => ({ nombre: txt, cantidad: 1, precioUnitario: 0 })),
  }));

  renderPedidos();
}


  async function actualizarEstadoEnSheets(pedidoId, estado) {
  const res = await fetch(SHEETS_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify({ accion: "actualizarEstado", pedidoId, estado }),
    redirect: "follow",
  });

  const txt = await res.text();
  console.log("UPDATE ESTADO (raw):", txt);

  let data;
  try { data = JSON.parse(txt); }
  catch (e) { throw new Error("La respuesta de actualizarEstado NO es JSON"); }

  if (!data.ok) throw new Error(data.error || "No se pudo actualizar estado");
}

  // Productos
  const productos = [
    {
      id: 1,
      nombre: "Clarasol Multiusos",
      precio: 8.0,
      desc: "Clarasol multiusos 1lt",
      img: "img/clarasol.jpg",
      icon: "üß¥",
      categoria: "limpieza",
    },
    {
      id: 2,
      nombre: "Detergente Ropa Color",
      precio: 18.0,
      desc: "Detergente para ropa de color 1lt",
      img: "img/detergente-color.jpg",
      icon: "üëï",
      categoria: "ropa",
    },
    {
      id: 3,
      nombre: "Detergente Ropa Blanca",
      precio: 18.0,
      desc: "Detergente para ropa blanca 1lt",
      img: "img/detergente-blanco.jpg",
      icon: "ü´ß",
      categoria: "ropa",
    },
    {
      id: 4,
      nombre: "Enjuague Ropa Color",
      precio: 18.0,
      desc: "Enjuague para ropa de color",
      img: "img/enjuague.jpg",
      icon: "üå∏",
      categoria: "suavizante",
    },
  ];

  const STORAGE_KEY = "mi_tienda_v1";
  const ADMIN_PIN = "1234"; // c√°mbialo

  function guardarEstado() {
    const data = { carrito, pedidos, folio };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  function cargarEstado() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;

    try {
      const data = JSON.parse(raw);

      carrito = Array.isArray(data.carrito) ? data.carrito : [];
      pedidos = (Array.isArray(data.pedidos) ? data.pedidos : []).map((p) => ({
        ...p,
        comprador: p?.comprador || { nombre: "", telefono: "", direccion: "" },
        items: Array.isArray(p?.items) ? p.items : [],
      }));
      folio = Number.isFinite(data.folio) ? data.folio : 1;
    } catch (e) {
      carrito = [];
      pedidos = [];
      folio = 1;
    }
  }

  function formatearFecha(iso) {
    if (!iso) return "";
    const d = new Date(iso);
    return d.toLocaleString("es-MX", {
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit",
    });
  }

  // Elementos
  const listaProductosEl = document.getElementById("lista-productos");
  const carritoItemsEl = document.getElementById("carrito-items");
  const totalEl = document.getElementById("total");
  const contadorEl = document.getElementById("contador");
  const btnVaciar = document.getElementById("vaciar");
  const btnCheckout = document.getElementById("checkout");

  const checkoutFormEl = document.getElementById("checkout-form");
  const nombreEl = document.getElementById("nombre");
  const telefonoEl = document.getElementById("telefono");
  const direccionEl = document.getElementById("direccion");
  const btnConfirmar = document.getElementById("confirmar");
  const btnCancelar = document.getElementById("cancelar");
  const listaPedidosEl = document.getElementById("lista-pedidos");

  const vistaClienteEl = document.getElementById("vistaCliente");
  const btnVistaCliente = document.getElementById("btnVistaCliente");
  const buscadorEl = document.getElementById("buscador");
  const btnHistorial = document.getElementById("btnHistorial");
  const btnExportar = document.getElementById("btnExportar");

  // Carrito
  function cambiarCantidad(productoId, delta) {
    const item = carrito.find((i) => i.productoId === productoId);
    if (!item) return;

    item.cantidad += delta;

    if (item.cantidad <= 0) {
      carrito = carrito.filter((i) => i.productoId !== productoId);
    }

    renderCarrito();
  }

  function vaciarCarrito() {
    carrito = [];
    renderCarrito();
  }

  function renderCarrito() {
    if (!Array.isArray(carrito) || carrito.length === 0) {
      carritoItemsEl.innerHTML = `<p class="muted">Tu carrito est√° vac√≠o.</p>`;
    } else {
      carritoItemsEl.innerHTML = "";

      carrito.forEach((item) => {
        const precio = Number(item.precioUnitario) || 0;
        const cant = Number(item.cantidad) || 0;
        const subtotal = precio * cant;

        const row = document.createElement("div");
        row.className = "item";
        row.innerHTML = `
          <div>
            <strong>${item.nombre}</strong><br>
            <span class="muted">$${precio.toFixed(2)} c/u</span>
          </div>

          <div class="qtyBtns">
            <button type="button" aria-label="menos">-</button>
            <span class="pill">${cant}</span>
            <button type="button" aria-label="m√°s">+</button>
          </div>

          <div><strong>$${subtotal.toFixed(2)}</strong></div>
          <div><button type="button" aria-label="quitar">Quitar</button></div>
        `;

        row
          .querySelector('button[aria-label="menos"]')
          .addEventListener("click", () => cambiarCantidad(item.productoId, -1));

        row
          .querySelector('button[aria-label="m√°s"]')
          .addEventListener("click", () => cambiarCantidad(item.productoId, +1));

        row
          .querySelector('button[aria-label="quitar"]')
          .addEventListener("click", () => {
            carrito = carrito.filter((i) => i.productoId !== item.productoId);
            renderCarrito();
          });

        carritoItemsEl.appendChild(row);
      });
    }

    const total = (carrito || []).reduce((acc, item) => {
      return acc + (Number(item.precioUnitario) || 0) * (Number(item.cantidad) || 0);
    }, 0);

    totalEl.textContent = total.toFixed(2);

    const contador = (carrito || []).reduce((acc, item) => acc + (Number(item.cantidad) || 0), 0);
    contadorEl.textContent = contador;

    guardarEstado();
  }

  // Productos
  function renderProductos() {
    const q = (buscadorEl.value || "").trim().toLowerCase();

    const filtrados = productos.filter((p) => {
      const texto = `${p.nombre} ${p.desc} ${p.categoria ?? ""}`.toLowerCase();
      return texto.includes(q);
    });

    listaProductosEl.innerHTML = "";

    if (filtrados.length === 0) {
      listaProductosEl.innerHTML = `
        <div class="card">
          <strong>No se encontraron productos</strong>
          <div class="muted" style="margin-top:6px;">Prueba con otra palabra.</div>
        </div>
      `;
      return;
    }

    filtrados.forEach((p) => {
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <img class="product-img add-by-image" data-id="${p.id}" src="${p.img}" alt="${p.nombre}" />

        <div class="row">
          <div style="display:flex; align-items:center; gap:10px;">
            <span class="icon-badge">${p.icon ?? "üõçÔ∏è"}</span>
            <h3 style="margin: 0;">${p.nombre}</h3>
          </div>
          <div class="tag ${p.categoria ?? ""}">${p.categoria ?? "producto"}</div>
        </div>

        <div class="row" style="margin-top:6px;">
          <span class="price">$${p.precio.toFixed(2)}</span>
        </div>

        <p class="muted" style="margin: 8px 0 12px;">${p.desc}</p>
        <button data-id="${p.id}" class="btn-primary">Agregar al carrito</button>
      `;

      listaProductosEl.appendChild(card);
    });
  }

  function agregarAlCarrito(productoId) {
    const p = productos.find((x) => x.id === productoId);
    if (!p) {
      alert("No se encontr√≥ el producto (id inv√°lido).");
      console.log("Producto no encontrado:", productoId);
      return;
    }

    const existente = carrito.find((i) => i.productoId === productoId);
    if (existente) {
      existente.cantidad += 1;
    } else {
      carrito.push({
        productoId: p.id,
        nombre: p.nombre,
        precioUnitario: p.precio,
        cantidad: 1,
      });
    }

    renderCarrito();
  }

  // Pedidos (ADMIN) ‚úÖ (limpio, sin duplicados)
  function renderPedidos() {
    listaPedidosEl.className = "";
    listaPedidosEl.innerHTML = "";

    const lista = viendoHistorial
      ? pedidos.filter((p) => p.estado === "archivado")
      : pedidos.filter((p) => p.estado !== "archivado");

    if (lista.length === 0) {
      listaPedidosEl.textContent = viendoHistorial ? "No hay pedidos archivados." : "A√∫n no hay pedidos.";
      listaPedidosEl.className = "muted";
      guardarEstado();
      return;
    }

    lista.forEach((p) => {
      const div = document.createElement("div");
      div.style.borderBottom = "1px solid rgba(255,255,255,.08)";
      div.style.padding = "12px 0";

      const items = (p.items || []).map((i) => `${i.nombre} x${i.cantidad}`).join(", ");

      div.innerHTML = `
        <div class="row">
          <strong>${p.id}</strong>
          <span class="pill">Estado: ${p.estado}</span>
        </div>

        <div style="margin-top:6px;">
          <div><strong>Cliente:</strong> ${p.comprador?.nombre || ""} (${p.comprador?.telefono || ""})</div>
          <div><strong>Direcci√≥n:</strong> ${p.comprador?.direccion || ""}</div>
          <div><strong>Items:</strong> ${items}</div>
          <div><strong>Total:</strong> $${Number(p.total || 0).toFixed(2)}</div>

          <div class="muted" style="margin-top:6px;">
            <div><strong>Creado:</strong> ${formatearFecha(p.creadoEn)}</div>
          </div>
        </div>

        ${
          viendoHistorial
            ? `
              <div class="row" style="margin-top:10px; justify-content:flex-end;">
                <button class="btn-primary" data-restore="${p.id}">Restaurar</button>
              </div>
            `
            : `
              <div style="margin-top:10px;" class="row">
                <label class="muted">Cambiar estado:</label>
                <select data-id="${p.id}">
                  <option value="pendiente" ${p.estado === "pendiente" ? "selected" : ""}>pendiente</option>
                  <option value="en_camino" ${p.estado === "en_camino" ? "selected" : ""}>en_camino</option>
                  <option value="entregado" ${p.estado === "entregado" ? "selected" : ""}>entregado</option>
                </select>
              </div>

              <div class="row" style="margin-top:10px; justify-content:flex-end;">
                <button class="btn-danger" data-archive="${p.id}">Archivar</button>
              </div>
            `
        }
      `;

      // üîÅ Cambiar estado (solo activos)
      const select = div.querySelector(`select[data-id="${p.id}"]`);
      if (select) {
        select.addEventListener("change", async (e) => {
          const nuevoEstado = e.target.value;
          try {
            await actualizarEstadoEnSheets(p.id, nuevoEstado);
            await cargarPedidosCentral();
          } catch (err) {
            console.error(err);
            alert("No se pudo actualizar el estado.");
            e.target.value = p.estado; // revertir
          }
        });
      }

      // üóÑÔ∏è Archivar (solo activos)
      const btnArch = div.querySelector(`[data-archive="${p.id}"]`);
      if (btnArch) {
        btnArch.addEventListener("click", async () => {
          if (!confirm("¬øArchivar este pedido?")) return;
          try {
            await actualizarEstadoEnSheets(p.id, "archivado");
            await cargarPedidosCentral();
          } catch (err) {
            console.error(err);
            alert("No se pudo archivar.");
          }
        });
      }

      // ‚ôªÔ∏è Restaurar (solo historial)
      const btnRes = div.querySelector(`[data-restore="${p.id}"]`);
      if (btnRes) {
        btnRes.addEventListener("click", async () => {
          if (!confirm("¬øRestaurar este pedido?")) return;
          try {
            await actualizarEstadoEnSheets(p.id, "pendiente");
            await cargarPedidosCentral();
          } catch (err) {
            console.error(err);
            alert("No se pudo restaurar.");
          }
        });
      }

      listaPedidosEl.appendChild(div);
    });

    guardarEstado();
  }

  function armarMensajeWhatsApp(pedido) {
    const itemsTxt = (pedido.items || [])
      .map((i) => `- ${i.nombre} x${i.cantidad} ($${i.precioUnitario.toFixed(2)} c/u)`)
      .join("\n");

    return `*NUEVO PEDIDO* ${pedido.id}
${formatearFecha(pedido.creadoEn)}

*Cliente:* ${pedido.comprador.nombre}
*Tel:* ${pedido.comprador.telefono}
*Direcci√≥n:* ${pedido.comprador.direccion}

*Items:*
${itemsTxt}

*Total:* $${pedido.total.toFixed(2)}
*Estado:* ${pedido.estado}`;
  }

  // Listeners (una sola vez)
  btnVaciar.addEventListener("click", () => {
    const ok = confirm("¬øSeguro que quieres vaciar el carrito? Esta acci√≥n no se puede deshacer.");
    if (!ok) return;
    vaciarCarrito();
  });

  function exportarPedidosCSV() {
    if (!pedidos || pedidos.length === 0) {
      alert("No hay pedidos para exportar.");
      return;
    }

    const filas = [];
    pedidos.forEach((p) => {
      (p.items || []).forEach((it) => {
        filas.push({
          pedido_id: p.id,
          estado: p.estado,
          creado: p.creadoEn || "",
          cliente: p.comprador?.nombre || "",
          telefono: p.comprador?.telefono || "",
          direccion: p.comprador?.direccion || "",
          item: it.nombre,
          cantidad: it.cantidad,
          precio_unitario: it.precioUnitario,
          subtotal_item: it.cantidad * it.precioUnitario,
          total_pedido: p.total,
        });
      });

      if (!p.items || p.items.length === 0) {
        filas.push({
          pedido_id: p.id,
          estado: p.estado,
          creado: p.creadoEn || "",
          cliente: p.comprador?.nombre || "",
          telefono: p.comprador?.telefono || "",
          direccion: p.comprador?.direccion || "",
          item: "",
          cantidad: "",
          precio_unitario: "",
          subtotal_item: "",
          total_pedido: p.total,
        });
      }
    });

    const encabezados = Object.keys(filas[0]);
    const escapeCSV = (v) => {
      const s = String(v ?? "");
      const needsQuotes = /[",\n]/.test(s);
      const escaped = s.replace(/"/g, '""');
      return needsQuotes ? `"${escaped}"` : escaped;
    };

    const csv = [encabezados.join(","), ...filas.map((row) => encabezados.map((k) => escapeCSV(row[k])).join(","))].join(
      "\n"
    );

    const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `pedidos_${new Date().toISOString().slice(0, 10)}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();

    URL.revokeObjectURL(url);
  }

  btnExportar?.addEventListener("click", exportarPedidosCSV);

  btnHistorial.addEventListener("click", () => {
    viendoHistorial = !viendoHistorial;
    btnHistorial.textContent = viendoHistorial ? "Ver activos" : "Ver historial";
    renderPedidos();
  });

  let buscadorTimer = null;
  buscadorEl.addEventListener("input", () => {
    if (buscadorTimer) clearTimeout(buscadorTimer);
    buscadorTimer = setTimeout(() => renderProductos(), 150);
  });

  listaProductosEl.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-id]");
    if (!btn) return;

    const id = parseInt(btn.dataset.id, 10);
    if (Number.isNaN(id)) return;
    agregarAlCarrito(id);
  });

  function mostrarCliente() {
    vistaClienteEl.style.display = "block";
    vistaAdminEl.style.display = "none";
  }

  function mostrarAdmin() {
    vistaClienteEl.style.display = "none";
    vistaAdminEl.style.display = "block";
    checkoutFormEl.style.display = "none";
  }

  btnVistaCliente.addEventListener("click", mostrarCliente);

  btnVistaAdmin.addEventListener("click", async () => {
    if (vistaAdminEl.style.display === "block") return;

    const intento = prompt("Ingresa el PIN de admin:");
    if (intento !== ADMIN_PIN) {
      alert("PIN incorrecto.");
      return;
    }

    mostrarAdmin();

    try {
      await cargarPedidosCentral();
    } catch (e) {
      console.error(e);
      alert("No pude cargar pedidos del sistema central.");
    }
  });

  btnSalirAdmin.addEventListener("click", () => {
    mostrarCliente();
  });

  // refresco admin cada 15s
  setInterval(() => {
    if (vistaAdminEl.style.display === "block") {
      cargarPedidosCentral().catch(() => {});
    }
  }, 15000);

  // Checkout
  btnCheckout.addEventListener("click", () => {
    if (carrito.length === 0) {
      alert("Tu carrito est√° vac√≠o.");
      return;
    }
    checkoutFormEl.style.display = "block";
  });

  btnCancelar.addEventListener("click", () => {
    checkoutFormEl.style.display = "none";
  });

  let enviandoPedido = false;

  btnConfirmar.addEventListener(
    "click",
    async (e) => {
      e.preventDefault();
      e.stopPropagation();

      if (enviandoPedido) return;

      const nombre = nombreEl.value.trim();
      const telefono = telefonoEl.value.trim();
      const direccion = direccionEl.value.trim();

      if (!nombre || !telefono || !direccion) {
        alert("Por favor llena nombre, tel√©fono y direcci√≥n.");
        return;
      }
      if (carrito.length === 0) {
        alert("Tu carrito est√° vac√≠o.");
        return;
      }

      enviandoPedido = true;
      btnConfirmar.disabled = true;
      const textoOriginal = btnConfirmar.textContent;
      btnConfirmar.textContent = "Enviando...";

      try {
        const total = carrito.reduce((acc, item) => acc + item.precioUnitario * item.cantidad, 0);

        const pedido = {
          id: `PED-${String(folio).padStart(4, "0")}`,
          items: carrito.map((i) => ({ ...i })),
          total,
          comprador: { nombre, telefono, direccion },
          estado: "pendiente",
          creadoEn: new Date().toISOString(),
        };

        // sube folio ANTES de enviar para evitar duplicados
        folio += 1;

        // guarda local
        pedidos.unshift(pedido);
        guardarEstado();

        await guardarPedidoEnSheets(pedido);
        await cargarPedidosCentral();

        // WhatsApp
        const texto = encodeURIComponent(armarMensajeWhatsApp(pedido));
        window.open(`https://wa.me/${WHATSAPP_NEGOCIO}?text=${texto}`, "_blank");

        // limpiar
        vaciarCarrito();
        nombreEl.value = "";
        telefonoEl.value = "";
        direccionEl.value = "";
        checkoutFormEl.style.display = "none";

        renderPedidos();
        alert(`Pedido creado: ${pedido.id}`);
      } catch (err) {
        console.error(err);
        alert("No se pudo enviar el pedido. Intenta de nuevo.");
      } finally {
        btnConfirmar.disabled = false;
        btnConfirmar.textContent = textoOriginal;
        enviandoPedido = false;
      }
    },
    true
  );

  // Click en imagen agrega al carrito
  document.addEventListener("click", function (e) {
    const img = e.target.closest(".add-by-image");
    if (!img) return;

    const id = img.getAttribute("data-id");
    const btn = document.querySelector(`button[data-id="${id}"]`);
    if (btn) btn.click();
  });

  // Iniciar
  cargarEstado();
  renderProductos();
  renderCarrito();
  renderPedidos();
  mostrarCliente();
</script>
</div> <!-- cierre de .container -->
</body>
</html>
